<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="pandoc" />

        <meta name="author" content="Yigong Hu" />
    
        <meta name="date" content="2022-05-16" />
    
    <title>HGWR Model and How to Use It</title>

        <script src="index_files/header-attrs-2.14/header-attrs.js"></script>
        <script src="index_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="index_files/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet" />
        <script src="index_files/bootstrap-3.3.7/js/bootstrap.min.js"></script>
        <script src="index_files/navigation-1.1/tabsets.js"></script>
        <link href="index_files/readthedown-0.1/readthedown.css" rel="stylesheet" />
        <link href="index_files/readthedown-0.1/readthedown_fonts_embed.css" rel="stylesheet" />
        <script src="index_files/readthedown-0.1/readthedown.js"></script>
    
    
        <style type="text/css">code{white-space: pre;}</style>
    <style type="text/css">
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          background-color: #ffffff;
          color: #a0a0a0;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
      div.sourceCode
        { color: #1f1c1b; background-color: #ffffff; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { color: #1f1c1b; } /* Normal */
      code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
      code span.an { color: #ca60ca; } /* Annotation */
      code span.at { color: #0057ae; } /* Attribute */
      code span.bn { color: #b08000; } /* BaseN */
      code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
      code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #924c9d; } /* Char */
      code span.cn { color: #aa5500; } /* Constant */
      code span.co { color: #898887; } /* Comment */
      code span.cv { color: #0095ff; } /* CommentVar */
      code span.do { color: #607880; } /* Documentation */
      code span.dt { color: #0057ae; } /* DataType */
      code span.dv { color: #b08000; } /* DecVal */
      code span.er { color: #bf0303; text-decoration: underline; } /* Error */
      code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
      code span.fl { color: #b08000; } /* Float */
      code span.fu { color: #644a9b; } /* Function */
      code span.im { color: #ff5500; } /* Import */
      code span.in { color: #b08000; } /* Information */
      code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
      code span.op { color: #1f1c1b; } /* Operator */
      code span.ot { color: #006e28; } /* Other */
      code span.pp { color: #006e28; } /* Preprocessor */
      code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
      code span.sc { color: #3daee9; } /* SpecialChar */
      code span.ss { color: #ff5500; } /* SpecialString */
      code span.st { color: #bf0303; } /* String */
      code span.va { color: #0057ae; } /* Variable */
      code span.vs { color: #bf0303; } /* VerbatimString */
      code span.wa { color: #bf0303; } /* Warning */
    </style>
    
        <link rel="stylesheet" href="style.css" type="text/css" />
    
    <!-- tabsets -->
    <script>
      $(document).ready(function () {
	  window.buildTabsets("toc");
      });
      $(document).ready(function () {
	  $('.tabset-dropdown > .nav-tabs > li').click(function () {
	      $(this).parent().toggleClass('nav-tabs-open')
	  });
      });
    </script>

    <!-- code folding -->
    
    <!-- code download -->
    
    <!-- tabsets dropdown -->

    <style type="text/css">
      .tabset-dropdown > .nav-tabs {
	  display: inline-table;
	  max-height: 500px;
	  min-height: 44px;
	  overflow-y: auto;
	  background: white;
	  border: 1px solid #ddd;
	  border-radius: 4px;
      }
      
      .tabset-dropdown > .nav-tabs > li.active:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
	  content: "&#xe258;";
	  border: none;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
	  content: "";
	  font-family: 'Glyphicons Halflings';
	  display: inline-block;
	  padding: 10px;
	  border-right: 1px solid #ddd;
      }
      
      .tabset-dropdown > .nav-tabs > li.active {
	  display: block;
      }

      .tabset-dropdown > .nav-tabs > li.active a {
  	  padding: 0 15px !important;
      }

      .tabset-dropdown > .nav-tabs > li > a,
      .tabset-dropdown > .nav-tabs > li > a:focus,
      .tabset-dropdown > .nav-tabs > li > a:hover {
	  border: none;
	  display: inline-block;
	  border-radius: 4px;
	  background-color: transparent;
      }
      
      .tabset-dropdown > .nav-tabs.nav-tabs-open > li {
	  display: block;
	  float: none;
      }
      
      .tabset-dropdown > .nav-tabs > li {
	  display: none;
	  margin-left: 0 !important;
      }
    </style>
    
</head>

<body class="preload">

   	
         <!-- readthedown start -->   
   <div id="content" data-toggle="wy-nav-shift">
     <nav id="nav-top" role="navigation" aria-label="top navigation">
       <a role="button" href="#" data-toggle="wy-nav-top"><span class="glyphicon glyphicon-menu-hamburger"></span></a>
     </nav>
         
   
        
      <h1 class="title">HGWR Model and How to Use It</h1>
      
         <!-- readthedown authors -->
   <div id="sidebar">
    <h2><a href="#content">HGWR Model and How to Use It</a></h2>
    <div id="toc">
      <ul>
      <li><a href="#introduction-to-hgwr-model">Introduction to HGWR
      Model</a>
      <ul>
      <li><a href="#what-is-hgwr-model">What is HGWR model?</a></li>
      <li><a href="#why-hgwr-model">Why HGWR model?</a></li>
      </ul></li>
      <li><a href="#modelling-with-hgwr-model">Modelling with HGWR
      Model</a>
      <ul>
      <li><a href="#installation">Installation</a></li>
      <li><a href="#usage">Usage</a></li>
      <li><a href="#example-a-small-simulated-data-set">Example: A Small
      Simulated Data Set</a></li>
      <li><a href="#example-large-scale-simulated-data">Example: Large
      Scale Simulated Data</a></li>
      <li><a
      href="#case-study-impact-factors-of-house-price-in-wuhan">Case
      Study: Impact Factors of House Price in Wuhan</a></li>
      </ul></li>
      <li><a href="#references">References</a></li>
      </ul>
    </div>
    <div id="postamble" data-toggle="wy-nav-shift" class="status">
                  <p class="author"><span class="glyphicon glyphicon-user"></span> Yigong
Hu</p>
                        <p class="date"><span class="glyphicon glyphicon-calendar"></span> 2022-05-16</p>
          </div>
   </div>
     

   
      
   
<!-- Don't indent these lines or it will mess pre blocks indentation --> 
<div id="main">
<p>A brief tutorial to Hierarchical and Geographically Weighted
Regression model and <strong>hgwrr</strong> package in R.</p>
<div id="introduction-to-hgwr-model" class="section level2">
<h2>Introduction to HGWR Model</h2>
<div id="what-is-hgwr-model" class="section level3">
<h3>What is HGWR model?</h3>
<p>Hierarchical and Geographically Weighted Regression, shorted for
HGWR, is a spatial modelling method designed for data of spatial
hierarchical structures. Just as its name implies, this is a combination
of Hierarchical Linear Model <span class="citation">(HLM, also known as
Multilevel Model, <a href="#ref-Raudenbush-1993"
role="doc-biblioref">Raudenbush 1993</a>)</span> and Geographically
Weighted Regression <span class="citation">(GWR, <a
href="#ref-BrunsdonFotheringham-1996" role="doc-biblioref">Brunsdon,
Fotheringham, and Charlton 1996</a>)</span>. In this model, spatial
effects are divided into three types: global fixed, local fixed and
random. Formally, it is expressed as <span class="math display">\[
y = G\gamma + X\beta + Z\mu + \epsilon
\]</span> with <span class="math inline">\(y\)</span> the dependent
variable, <span class="math inline">\(G\)</span> the group level
independent variables, <span class="math inline">\(\gamma\)</span> the
local fixed effects, <span class="math inline">\(X\)</span> also the
group level independent variables, <span
class="math inline">\(\beta\)</span> the global fixed effects, <span
class="math inline">\(Z\)</span> the individual level independent
variables, <span class="math inline">\(\mu\)</span> the random effects,
<span class="math inline">\(\epsilon\)</span> the individual errors.</p>
</div>
<div id="why-hgwr-model" class="section level3">
<h3>Why HGWR model?</h3>
<p>As we know, hierarchical structure is commonly existing in spatial
data. For example, cities can be grouped by provinces or other
higher-level administrative district they belong to; house prices may
share some factors from the block; and students in one school have
different access to education resources with those in another school.
When dealing with this type of data, we usually choose HLM to address
the within-group homogeneity and the between-group heterogeneity. And
there are usually two types of variables: group-level variables and
sample-level variables. The formal ones are used to describe the
properties of groups (such as the provinces, blocks and schools); the
latter ones are observations of individual samples (such as the cities,
houses and students). The effect of some sample-level variables are
similar in all groups, thus they are modelled with fixed coefficients
(effects). For others, they are modelled individually, i.e., with random
effects.</p>
<p>However, for group-level variables, they can only be modelled with
fixed effects. For spatial data, we would encounter some problems.
According to the Tobler’s first law of Geography “Everything is related
to everything else, but near things are more related than distant
things” <span class="citation">(<a href="#ref-Tobler-1970"
role="doc-biblioref">Tobler 1970</a>)</span>. If the model is calibrated
with equally weighted samples, spatial heterogeneity would be overlooked
<span class="citation">(<a href="#ref-FotheringhamBrunsdon-2002"
role="doc-biblioref">Fotheringham, Brunsdon, and Charlton
2002</a>)</span>. Thus, it requires us to distinguish “local fixed
effects” from “global fixed effects” to discover spatial heterogeneity
in group-level variables.</p>
<p>But why not GWR or Multiscale GWR <span class="citation">(<a
href="#ref-FotheringhamYang-2017" role="doc-biblioref">Fotheringham,
Yang, and Kang 2017, LuBrunsdon–2017</a>)</span> Because when dealing
with data of hierarchical structures, GWR is problematic <span
class="citation">(<a href="#ref-HuLu-2022" role="doc-biblioref">Hu et
al. 2022</a>)</span>. We know that GWR calibrate a model with unique
coefficients on each sample by borrowing data from its neighbours. And
it uses a parameter “bandwidth” to control how many neighbours are
included. If samples are not hierarchically structured, everything works
well. However, just imagine a situation like Figure 1. For the two
samples of red color and blue color, we take the same number of their
neighbours, but actually the spatial extents are not the same. In
extreme cases, spatial extends of some samples could be too small to
hold more than one or two location, but some are large enough. This
would lead to the failure of bandwidth optimization and reduce the
reliability of the optimized bandwidth.</p>
<video autoplay muted controls>
<source src="assets/multisampling.mp4" type="video/mp4">
</video>
<blockquote>
<p>As shown in this video, bandwidths have inequal spatial scale for two
samples (represented by cubes). Both the samples represented by large
red cubes and large blue cubes take 41 neighbour samples to calibrate
GWR models. For the red one, neighbours on 8 nearest locations are
taken. But the figure for the blue one is only 6. This situation means
estimated coefficients are more smoothed for the red samples. In other
words, estimations for the blue samples are much local.</p>
</blockquote>
<p>To solve the problems mentioned above, we need to use HGWR model. It
is able to modelling spatial hierarchical structure and spatial
heterogeneity simultaneously. Examples below can show that it works well
for spatial hierarchical data.</p>
</div>
</div>
<div id="modelling-with-hgwr-model" class="section level2">
<h2>Modelling with HGWR Model</h2>
<p>The R package <strong>hgwrr</strong> is built for calibrating HGWR
model. In this section, we are going to show how to use it.</p>
<div id="installation" class="section level3">
<h3>Installation</h3>
<p>Package <strong>hgwrr</strong> is available on <a
href="https://cran.r-project.org/package=hgwrr">CRAN</a>. Simply type
the following codes to install it.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;hgwrr&quot;</span>)</span></code></pre></div>
<p>Or download <a
href="https://github.com/HPDell/hgwr/releases/latest">latest released
source package</a> and run the following command to install this
package.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD INSTALL hgwrr_0.2-0.tar.gz</span></code></pre></div>
<p>Note that <a
href="https://cran.r-project.org/bin/windows/Rtools/">RTools</a> is
required on Windows.</p>
</div>
<div id="usage" class="section level3">
<h3>Usage</h3>
<p>We are going to show the usage of <strong>hgwrr</strong> package with
a simulated data.</p>
<p>First, we need to load this package in an R session.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hgwrr)</span></code></pre></div>
<p>Then we can calibrate an HGWR model via <code>hgwr()</code>
function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hgwr</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  formula, data, local.fixed, coords, bw,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fl">0.01</span>, <span class="at">eps_iter =</span> <span class="fl">1e-06</span>, <span class="at">eps_gradient =</span> <span class="fl">1e-06</span>, <span class="at">max_iters =</span> <span class="fl">1e+06</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_retries =</span> <span class="dv">10</span>, <span class="at">ml_type =</span> HGWR_ML_TYPE_D_ONLY, <span class="at">verbose =</span> <span class="dv">0</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The first five arguments are mandatory.</p>
<ul>
<li><p><code>formula</code> accepts a formula object in R. Its format
follows <strong>lme4</strong> package. As there are two types of
effects: fixed effects and random effects, we use the following format
to specify both of them:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dependent <span class="sc">~</span> fixed1 <span class="sc">+</span> fixed2 <span class="sc">+</span> (random1 <span class="sc">+</span> random2 <span class="sc">|</span> group)</span></code></pre></div></li>
<li><p><code>data</code> accepts a DataFrame object in R. All variables
specified in <code>formula</code> are extracted from <code>data</code>.
In this stage, <code>Spatial*DataFrame</code> is not supported.</p></li>
<li><p><code>local.fixed</code> accepts a list of character specifying
which fixed effects are local. For example, if <code>fixed1</code> needs
to be local fixed, then set <code>local.fixed</code> to
<code>c("fixed1")</code>.</p></li>
<li><p><code>coords</code> accepts a matrix of 2 columns. Each row is
the longitude and latitude of each group.</p></li>
<li><p><code>bw</code> accepts a integer or numeric number to specify
the bandwidth used in geographically weighted process. Currently it can
only be adaptive bandwidth.</p></li>
</ul>
<p>Other arguments are optional which is used to control the backfitting
maximum likelihood algorithm. On most occassions the default values are
fine. If the default values cause some problems and you want change some
of them, please check the documentation of function <code>hgwr()</code>
for more infomation.</p>
</div>
<div id="example-a-small-simulated-data-set" class="section level3">
<h3>Example: A Small Simulated Data Set</h3>
<p><em>This example is used to show the usage of this package and to
test whether it works. We don’t care about how good the fitness of this
model is with this data set.</em></p>
<p>A data set “multisampling” is provided with this package,</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(multisampling)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(multisampling<span class="sc">$</span>data)</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">y</th>
<th align="right">g1</th>
<th align="right">g2</th>
<th align="right">z1</th>
<th align="right">x1</th>
<th align="right">group</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1.2311965</td>
<td align="right">0.1706889</td>
<td align="right">-0.2246718</td>
<td align="right">1.4808437</td>
<td align="right">0.7930132</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">2.7154442</td>
<td align="right">0.1706889</td>
<td align="right">-0.2246718</td>
<td align="right">0.4890035</td>
<td align="right">0.5222513</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">1.9980754</td>
<td align="right">0.1706889</td>
<td align="right">-0.2246718</td>
<td align="right">-0.2261288</td>
<td align="right">1.7462222</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">3.7671728</td>
<td align="right">0.1706889</td>
<td align="right">-0.2246718</td>
<td align="right">0.3268472</td>
<td align="right">-1.2713361</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">4.4938533</td>
<td align="right">0.1706889</td>
<td align="right">-0.2246718</td>
<td align="right">1.8754945</td>
<td align="right">2.1973895</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">0.7256683</td>
<td align="right">0.1706889</td>
<td align="right">-0.2246718</td>
<td align="right">-0.3023764</td>
<td align="right">0.4331308</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(multisampling<span class="sc">$</span>coord)</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">U</th>
<th align="right">V</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2940.897</td>
<td align="right">2851.943</td>
</tr>
<tr class="even">
<td align="right">3002.659</td>
<td align="right">3157.717</td>
</tr>
<tr class="odd">
<td align="right">2848.345</td>
<td align="right">2904.326</td>
</tr>
<tr class="even">
<td align="right">2863.735</td>
<td align="right">2907.999</td>
</tr>
<tr class="odd">
<td align="right">3117.849</td>
<td align="right">2800.236</td>
</tr>
<tr class="even">
<td align="right">2906.585</td>
<td align="right">2972.770</td>
</tr>
</tbody>
</table>
</div>
<p>where <code>y</code> is the dependent variable, <code>g1</code> and
<code>g2</code> are two group-level variables, <code>z1</code> and
<code>x1</code> are two sample-level variables, <code>group</code> are
the labels of the groups they belong to, and <code>U</code>,
<code>V</code> are longitude and latitude coordinate values of all
groups.</p>
<p>We regards <code>g1</code> and <code>g2</code> have local fixed
effects, <code>x1</code> have global fixed effects and <code>z1</code>
have random effects. Then we can calibrate an HGWR model with like
this</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">hgwr</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> y <span class="sc">~</span> g1 <span class="sc">+</span> g2 <span class="sc">+</span> x1 <span class="sc">+</span> (z1 <span class="sc">|</span> group),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> multisampling<span class="sc">$</span>data,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">local.fixed =</span> <span class="fu">c</span>(<span class="st">&quot;g1&quot;</span>, <span class="st">&quot;g2&quot;</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> multisampling<span class="sc">$</span>coord,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw =</span> <span class="dv">10</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>model1</span></code></pre></div>
<pre><code>## Hierarchical and geographically weighted regression model 
## ========================================================= 
## Formula: y ~ g1 + g2 + x1 + (z1 | group) 
##  Method: Back-fitting and Maximum likelihood 
##    Data: multisampling$data 
## 
## Global Fixed Effects 
## ------------------- 
##     Intercept        x1 
##  -4538.623106  0.964530 
## 
## Local Fixed Effects 
## ------------------- 
##  Coefficient          Min  1st Quartile       Median  3rd Quartile          Max 
##    Intercept  4540.169533   4540.258191  4540.536449   4540.825440  4541.111718 
##           g1     5.919438      6.366335     7.282849      7.877878     9.261846 
##           g2    -0.935852      0.052836     0.978779      1.494663     2.178014 
## 
## Random Effects 
## -------------- 
##    Groups       Name    Std.Dev.      Corr 
##     group  Intercept  778.316317           
##                   z1   49.552648  0.063573 
##  Residual               1.900196           
## 
## Other Information 
## ----------------- 
## Number of Obs: 484 
##        Groups: group , 16</code></pre>
<p>The output of the model shows estimations of global fixed effects,
summary of those of local fixed effects. Also there are the standard
deviations of random effects and correlation coefficients between
them.</p>
<p>Then we can have a look on the coefficient estimations.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model1)</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">Intercept</th>
<th align="right">g1</th>
<th align="right">g2</th>
<th align="right">x1</th>
<th align="right">z1</th>
<th align="right">group</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.7575213</td>
<td align="right">8.073992</td>
<td align="right">-0.0488209</td>
<td align="right">0.9645297</td>
<td align="right">-0.1886598</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">3.4042278</td>
<td align="right">7.035509</td>
<td align="right">1.3211308</td>
<td align="right">0.9645297</td>
<td align="right">0.3153482</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">0.7623931</td>
<td align="right">7.660647</td>
<td align="right">0.8469575</td>
<td align="right">0.9645297</td>
<td align="right">1.3234052</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="right">2.4643282</td>
<td align="right">7.591925</td>
<td align="right">0.9277784</td>
<td align="right">0.9645297</td>
<td align="right">-0.6226628</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="right">5.8517603</td>
<td align="right">9.261846</td>
<td align="right">-0.9358521</td>
<td align="right">0.9645297</td>
<td align="right">-1.5012307</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="right">0.6818849</td>
<td align="right">6.228258</td>
<td align="right">1.7987301</td>
<td align="right">0.9645297</td>
<td align="right">0.7493044</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">2.6272027</td>
<td align="right">8.301746</td>
<td align="right">-0.0470795</td>
<td align="right">0.9645297</td>
<td align="right">-1.5212598</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="right">3.5158609</td>
<td align="right">7.969104</td>
<td align="right">0.0441887</td>
<td align="right">0.9645297</td>
<td align="right">0.3311799</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="right">1.0563234</td>
<td align="right">6.262002</td>
<td align="right">1.3913978</td>
<td align="right">0.9645297</td>
<td align="right">0.6206638</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="right">1.1177829</td>
<td align="right">5.919438</td>
<td align="right">2.1780138</td>
<td align="right">0.9645297</td>
<td align="right">-0.8921036</td>
<td align="right">10</td>
</tr>
<tr class="odd">
<td align="right">1.0775400</td>
<td align="right">6.968977</td>
<td align="right">1.3304763</td>
<td align="right">0.9645297</td>
<td align="right">0.3229058</td>
<td align="right">11</td>
</tr>
<tr class="even">
<td align="right">0.4547059</td>
<td align="right">7.786652</td>
<td align="right">0.0614841</td>
<td align="right">0.9645297</td>
<td align="right">-0.4205407</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="right">0.2454580</td>
<td align="right">7.517574</td>
<td align="right">1.0297799</td>
<td align="right">0.9645297</td>
<td align="right">1.6211414</td>
<td align="right">13</td>
</tr>
<tr class="even">
<td align="right">3.2664446</td>
<td align="right">6.117750</td>
<td align="right">1.5979289</td>
<td align="right">0.9645297</td>
<td align="right">0.0050019</td>
<td align="right">14</td>
</tr>
<tr class="odd">
<td align="right">1.8603374</td>
<td align="right">6.470669</td>
<td align="right">1.7181931</td>
<td align="right">0.9645297</td>
<td align="right">0.0483338</td>
<td align="right">15</td>
</tr>
<tr class="even">
<td align="right">2.2202882</td>
<td align="right">7.048124</td>
<td align="right">0.5651645</td>
<td align="right">0.9645297</td>
<td align="right">-0.0496753</td>
<td align="right">16</td>
</tr>
</tbody>
</table>
</div>
<p>With <strong>ggplot2</strong> or other packages, we can create some
figures.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>model1_coef_coord <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(multisampling<span class="sc">$</span>coord, <span class="fu">coef</span>(model1)))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model1_coef_coord, <span class="fu">aes</span>(<span class="at">x =</span> U, <span class="at">y =</span> V)) <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> g1)) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" width="768" /></p>
<p>We can also convert it to spatial data and use <strong>tmap</strong>
to visualize.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>model1_coef_coord_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(model1_coef_coord,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">coords =</span> <span class="fu">names</span>(multisampling<span class="sc">$</span>coord),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">crs =</span> <span class="dv">27700</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(model1_coef_coord_sf) <span class="sc">+</span> <span class="fu">tm_dots</span>(<span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;g1&quot;</span>, <span class="st">&quot;g2&quot;</span>), <span class="at">size =</span> <span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" width="768" /></p>
<p>And we can also fetch the fitted and residuals.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">data.frame</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">real =</span> multisampling<span class="sc">$</span>data<span class="sc">$</span>y,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fitted =</span> <span class="fu">fitted</span>(model1),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">residuals =</span> <span class="fu">residuals</span>(model1)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">real</th>
<th align="right">fitted</th>
<th align="right">residuals</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1.2311965</td>
<td align="right">2.6321401</td>
<td align="right">-1.4009436</td>
</tr>
<tr class="even">
<td align="right">2.7154442</td>
<td align="right">2.5581026</td>
<td align="right">0.1573416</td>
</tr>
<tr class="odd">
<td align="right">1.9980754</td>
<td align="right">3.8735757</td>
<td align="right">-1.8755003</td>
</tr>
<tr class="even">
<td align="right">3.7671728</td>
<td align="right">0.8587268</td>
<td align="right">2.9084461</td>
</tr>
<tr class="odd">
<td align="right">4.4938533</td>
<td align="right">3.9122480</td>
<td align="right">0.5816052</td>
</tr>
<tr class="even">
<td align="right">0.7256683</td>
<td align="right">2.6214449</td>
<td align="right">-1.8957766</td>
</tr>
</tbody>
</table>
</div>
<p>The <code>summary()</code> function will give some statistical
information about this model.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span></code></pre></div>
<pre><code>## Hierarchical and geographically weighted regression model 
## ========================================================= 
## Formula: y ~ g1 + g2 + x1 + (z1 | group) 
##  Method: Back-fitting and Maximum likelihood 
##    Data: multisampling$data 
## 
## Diagnostics 
## ----------- 
##  Rsquared 
##  0.647278 
## 
## Scaled residuals 
## ---------------- 
##        Min         1Q     Median        3Q       Max 
##  -5.457712  -1.200908  -0.066369  1.264277  5.293872 
## 
## Other Information 
## ----------------- 
## Number of Obs: 484 
##        Groups: group , 16</code></pre>
<p>On the current stage, only pesudo <span
class="math inline">\(R^2\)</span> is available. In the future, more
diagnostic information will be provided in this package.</p>
</div>
<div id="example-large-scale-simulated-data" class="section level3">
<h3>Example: Large Scale Simulated Data</h3>
<p>In the former example, there are only 484 observations and 16 groups.
They are not adequate enough to get precises estimations. Here, we are
going to use a large scale simulated data set to show the performance of
HGWR model. As the true value of coefficients are already known (stored
in variable <code>hgwr_beta</code>), closeness between estimated and
true values is an appliable performance metric.</p>
<p>The data set is provided <a href="./data/example2.rda">here</a>. Its
structure is similar to data <code>multisampling</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;data/example2.rda&quot;</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hgwr_data)</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">y</th>
<th align="right">g1</th>
<th align="right">g2</th>
<th align="right">x1</th>
<th align="right">z1</th>
<th align="right">group</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2.090256</td>
<td align="right">0.1933745</td>
<td align="right">-0.057836</td>
<td align="right">0.7930132</td>
<td align="right">1.1432041</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">3.456452</td>
<td align="right">0.1933745</td>
<td align="right">-0.057836</td>
<td align="right">0.5222513</td>
<td align="right">1.0198745</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">2.876627</td>
<td align="right">0.1933745</td>
<td align="right">-0.057836</td>
<td align="right">1.7462222</td>
<td align="right">-0.7071740</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">4.510162</td>
<td align="right">0.1933745</td>
<td align="right">-0.057836</td>
<td align="right">-1.2713361</td>
<td align="right">0.8431381</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">5.583738</td>
<td align="right">0.1933745</td>
<td align="right">-0.057836</td>
<td align="right">2.1973895</td>
<td align="right">-0.1603318</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">1.601511</td>
<td align="right">0.1933745</td>
<td align="right">-0.057836</td>
<td align="right">0.4331308</td>
<td align="right">-0.7634945</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hgwr_coords)</span></code></pre></div>
<pre><code>##            V1       V2
## [1,] 2940.897 2851.943
## [2,] 3002.659 3157.717
## [3,] 2848.345 2904.326
## [4,] 2863.735 2907.999
## [5,] 3117.849 2800.236
## [6,] 2906.585 2972.770</code></pre>
<p>In this data, we also regards <code>g1</code> and <code>g2</code> as
two group-level variables, <code>z1</code> and <code>x1</code> as two
sample-level variables, <code>group</code> as the labels of the groups
they belong to, and <code>U</code>, <code>V</code> as longitude and
latitude coordinate values of all groups. Then we calibrate an HGWR
model.</p>
<blockquote>
<p>As the data is large (13862 observations), it may take some time to
get results.</p>
</blockquote>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>hgwr_formula <span class="ot">&lt;-</span> y <span class="sc">~</span> g1 <span class="sc">+</span> g2 <span class="sc">+</span> x1 <span class="sc">+</span> (z1 <span class="sc">|</span> group)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">hgwr</span>(<span class="at">formula =</span> hgwr_formula,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> hgwr_data,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">local.fixed =</span> <span class="fu">c</span>(<span class="st">&quot;g1&quot;</span>, <span class="st">&quot;g2&quot;</span>),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">coords =</span> hgwr_coords,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">bw =</span> <span class="dv">32</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">kernel =</span> <span class="st">&quot;bisquared&quot;</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>model2</span></code></pre></div>
<pre><code>## Hierarchical and geographically weighted regression model 
## ========================================================= 
## Formula: hgwr_formula 
##  Method: Back-fitting and Maximum likelihood 
##    Data: hgwr_data 
## 
## Global Fixed Effects 
## ------------------- 
##  Intercept        x1 
##   3.142118  1.010699 
## 
## Local Fixed Effects 
## ------------------- 
##  Coefficient         Min  1st Quartile     Median  3rd Quartile        Max 
##    Intercept   -2.099433     -1.501617  -1.330840     -1.160251  -0.637086 
##           g1   -3.495954      0.264949   3.452187      6.340162  11.766479 
##           g2  -11.003983     -2.416328  -0.251891      1.704997   8.757358 
## 
## Random Effects 
## -------------- 
##    Groups       Name  Std.Dev.       Corr 
##     group  Intercept  1.743385            
##                   z1  1.841777  -0.178200 
##  Residual             1.991062            
## 
## Other Information 
## ----------------- 
## Number of Obs: 13862 
##        Groups: group , 200</code></pre>
<div id="fitness-assessment" class="section level4">
<h4>Fitness Assessment</h4>
<p>Then we check the estimations of intercept, <code>g1</code>,
<code>g2</code> and <code>z1</code> via some scatter plots.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(model2) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Intercept, g1, g2, z1) <span class="sc">%&gt;%</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">label =</span> <span class="fu">names</span>(.), <span class="at">Truth =</span> hgwr_beta[<span class="fu">names</span>(.)], <span class="at">Estimated =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap_df</span>(data.frame) <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">factor</span>(label, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;Intercept&quot;</span>, <span class="st">&quot;g1&quot;</span>, <span class="st">&quot;g2&quot;</span>, <span class="st">&quot;z1&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Truth, <span class="at">y =</span> Estimated)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span> <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">25</span>, <span class="dv">25</span>)) <span class="sc">+</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> label) <span class="sc">+</span> </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" width="768" /></p>
<p>In addition to these scatter plots, root mean squared errors (RMSE)
and mean absolute errors of estimations and true values are also very
useful to assess the fitting performance.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>model2_hgwr_err <span class="ot">&lt;-</span> <span class="fu">coef</span>(model2) <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Intercept, g1, g2, x1, z1) <span class="sc">%&gt;%</span> {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">MAE =</span> <span class="fu">map2_dbl</span>(hgwr_beta, ., <span class="sc">~</span> <span class="fu">mean</span>(<span class="fu">abs</span>(.x <span class="sc">-</span> .y))),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">RMSE =</span> <span class="fu">map2_dbl</span>(hgwr_beta, ., <span class="sc">~</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((.x <span class="sc">-</span> .y)<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>model2_hgwr_err</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Intercept</th>
<th align="right">g1</th>
<th align="right">g2</th>
<th align="right">z1</th>
<th align="right">x1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MAE</td>
<td align="right">0.3529462</td>
<td align="right">2.437674</td>
<td align="right">2.134569</td>
<td align="right">1.165641</td>
<td align="right">1.148090</td>
</tr>
<tr class="even">
<td align="left">RMSE</td>
<td align="right">0.4856966</td>
<td align="right">3.703679</td>
<td align="right">2.862071</td>
<td align="right">1.382563</td>
<td align="right">1.371016</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="comparison-of-hgwr-gwr-and-hlm" class="section level4">
<h4>Comparison of HGWR, GWR and HLM</h4>
<p>As a comparison, we can also calibrate a GWR model and HLM model and
have a look at their fitting performance. THe GWR model can be
calibrated with the following codes.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">### GWR model</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GWmodel)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>gwr_data <span class="ot">&lt;-</span> hgwr_data</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(gwr_data) <span class="ot">&lt;-</span> hgwr_coords[hgwr_data<span class="sc">$</span>group, ]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="do">##### Get optimized bandwidth via golden minimization algorithm.</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>gwr_bw <span class="ot">&lt;-</span> <span class="fu">bw.gwr</span>(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> y <span class="sc">~</span> g1 <span class="sc">+</span> g2 <span class="sc">+</span> x1 <span class="sc">+</span> z1, <span class="at">data =</span> gwr_data, <span class="at">approach =</span> <span class="st">&quot;AIC&quot;</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">parallel.method =</span> <span class="st">&quot;omp&quot;</span>, <span class="at">parallel.arg =</span> <span class="dv">8</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Take a cup of tea and have a break, it will take a few minutes.
##           -----A kind suggestion from GWmodel development group
## Adaptive bandwidth (number of nearest neighbours): 8574 AICc value: 64882.39 
## Adaptive bandwidth (number of nearest neighbours): 5307 AICc value: 64454.28 
## Adaptive bandwidth (number of nearest neighbours): 3286 AICc value: 64047.9 
## Adaptive bandwidth (number of nearest neighbours): 2039 AICc value: 63620.4 
## Adaptive bandwidth (number of nearest neighbours): 1266 AICc value: 62999.43 
## Adaptive bandwidth (number of nearest neighbours): 790 AICc value: 62173.75 
## Adaptive bandwidth (number of nearest neighbours): 494 AICc value: 61359.34 
## Adaptive bandwidth (number of nearest neighbours): 313 AICc value: 60434.33 
## Adaptive bandwidth (number of nearest neighbours): 199 AICc value: 1071693 
## Adaptive bandwidth (number of nearest neighbours): 381 AICc value: 60780.34 
## Adaptive bandwidth (number of nearest neighbours): 268 AICc value: 1013623 
## Adaptive bandwidth (number of nearest neighbours): 338 AICc value: 60513.49 
## Adaptive bandwidth (number of nearest neighbours): 295 AICc value: 60292.35 
## Adaptive bandwidth (number of nearest neighbours): 286 AICc value: 60250.93 
## Adaptive bandwidth (number of nearest neighbours): 278 AICc value: 1013623 
## Adaptive bandwidth (number of nearest neighbours): 288 AICc value: 60255.59 
## Adaptive bandwidth (number of nearest neighbours): 281 AICc value: 60239.58 
## Adaptive bandwidth (number of nearest neighbours): 282 AICc value: 60239.58</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">##### Calibrate GWR model with optimized bandwidth.</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>model2_gwr <span class="ot">&lt;-</span> <span class="fu">gwr.basic</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> y <span class="sc">~</span> g1 <span class="sc">+</span> g2 <span class="sc">+</span> x1 <span class="sc">+</span> z1, <span class="at">data =</span> gwr_data, <span class="at">bw =</span> gwr_bw,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">adaptive =</span> <span class="cn">TRUE</span>, <span class="at">parallel.method =</span> <span class="st">&quot;omp&quot;</span>, <span class="at">parallel.arg =</span> <span class="dv">8</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="do">#### Get coefficient estimations.</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="do">#### As samples in one group have equal estimations,</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="do">#### we use mean value of each group to represent them.</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>model2_gwr_coef <span class="ot">&lt;-</span> <span class="fu">cbind</span>(model2_gwr<span class="sc">$</span>SDF<span class="sc">@</span>data, <span class="at">group =</span> gwr_data<span class="sc">$</span>group) <span class="sc">%&gt;%</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Intercept =</span> <span class="fu">mean</span>(Intercept),</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">g1 =</span> <span class="fu">mean</span>(g1), <span class="at">g2 =</span> <span class="fu">mean</span>(g2), <span class="at">z1 =</span> <span class="fu">mean</span>(z1), <span class="at">x1 =</span> <span class="fu">mean</span>(x1))</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="do">##### Calculate RMSE and MAE of estimations.</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>model2_gwr_err <span class="ot">&lt;-</span> model2_gwr_coef <span class="sc">%&gt;%</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Intercept, g1, g2, x1, z1) <span class="sc">%&gt;%</span> {</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">MAE =</span> <span class="fu">map2_dbl</span>(hgwr_beta, ., <span class="sc">~</span> <span class="fu">mean</span>(<span class="fu">abs</span>(.x <span class="sc">-</span> .y))),</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">RMSE =</span> <span class="fu">map2_dbl</span>(hgwr_beta, ., <span class="sc">~</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((.x <span class="sc">-</span> .y)<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>model2_gwr_err</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Intercept</th>
<th align="right">g1</th>
<th align="right">g2</th>
<th align="right">z1</th>
<th align="right">x1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MAE</td>
<td align="right">5.27123</td>
<td align="right">54.27019</td>
<td align="right">206.523</td>
<td align="right">1.145032</td>
<td align="right">0.9914012</td>
</tr>
<tr class="even">
<td align="left">RMSE</td>
<td align="right">44.07530</td>
<td align="right">478.03679</td>
<td align="right">2667.250</td>
<td align="right">1.376936</td>
<td align="right">1.1573819</td>
</tr>
</tbody>
</table>
</div>
<p>And also a HLM model calibrated with the following codes.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>model2_hlm <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> y <span class="sc">~</span> g1 <span class="sc">+</span> g2 <span class="sc">+</span> x1 <span class="sc">+</span> (z1 <span class="sc">|</span> group),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> hgwr_data</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>model2_hlm_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(model2_hlm)<span class="sc">$</span>group</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(model2_hlm_coef)[<span class="fu">which</span>(<span class="fu">colnames</span>(model2_hlm_coef) <span class="sc">==</span> <span class="st">&quot;(Intercept)&quot;</span>)] <span class="ot">&lt;-</span> <span class="st">&quot;Intercept&quot;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>model2_hlm_err <span class="ot">&lt;-</span> model2_hlm_coef <span class="sc">%&gt;%</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Intercept, g1, g2, x1, z1) <span class="sc">%&gt;%</span> {</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">MAE =</span> <span class="fu">map2_dbl</span>(hgwr_beta, ., <span class="sc">~</span> <span class="fu">mean</span>(<span class="fu">abs</span>(.x <span class="sc">-</span> .y))),</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">RMSE =</span> <span class="fu">map2_dbl</span>(hgwr_beta, ., <span class="sc">~</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((.x <span class="sc">-</span> .y)<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>model2_hlm_err</span></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Intercept</th>
<th align="right">g1</th>
<th align="right">g2</th>
<th align="right">z1</th>
<th align="right">x1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MAE</td>
<td align="right">0.5403015</td>
<td align="right">3.961721</td>
<td align="right">3.183228</td>
<td align="right">1.165328</td>
<td align="right">1.128811</td>
</tr>
<tr class="even">
<td align="left">RMSE</td>
<td align="right">0.8043435</td>
<td align="right">5.423963</td>
<td align="right">4.610203</td>
<td align="right">1.382253</td>
<td align="right">1.340799</td>
</tr>
</tbody>
</table>
</div>
<p>A bar plot will be helpful here to compare the fitness of these three
models.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">HGWR =</span> model2_hgwr_err, <span class="at">GWR =</span> model2_gwr_err, <span class="at">HLM =</span> model2_hlm_err) <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map2_dfr</span>(., <span class="fu">names</span>(.), <span class="cf">function</span>(x, nx) {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map2_dfr</span>(x, <span class="fu">colnames</span>(x), <span class="cf">function</span>(i, ni) {</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(<span class="at">Coefficient =</span> ni, <span class="at">Label =</span> <span class="fu">rownames</span>(x), <span class="at">Value =</span> i)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> <span class="fu">cbind</span>(<span class="at">Algorithm =</span> nx, .)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Coefficient, <span class="at">y =</span> Value, <span class="at">group =</span> Algorithm, <span class="at">fill =</span> Algorithm)) <span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(Value, <span class="dv">2</span>), <span class="at">y =</span> <span class="fu">pmin</span>(Value, <span class="dv">10</span>), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.2</span>),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.9</span>)) <span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(Label)) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">oob =</span> scales<span class="sc">::</span>squish,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">add =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" width="768" /></p>
<blockquote>
<p>Note that in this figure we limited the scale of y axis to make the
bar for <code>x1</code> and <code>z1</code> more obvious. The actual
numbers are labelled above bars.</p>
</blockquote>
<p>We can say that HGWR has best fitness among these three models. It is
able to give more precise estimations for local fixed effects. And it
can estimate global fixed effects and also random effects as precisely
as HLM does, but more precisely than GWR does.</p>
</div>
</div>
<div id="case-study-impact-factors-of-house-price-in-wuhan"
class="section level3">
<h3>Case Study: Impact Factors of House Price in Wuhan</h3>
<p>As the fitness of HGWR has been demonstrated with simulation data, we
are thing about applying it in collected data sets. Here we are going to
use a case study to show the usage of HGWR on this type of data. The
data set is provided in this <a
href="./data/wuhan_house_price.rda">file</a>.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;data/wuhan_house_price.rda&quot;</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(house_price)</span></code></pre></div>
<div class="kable-table">
<table>
<colgroup>
<col width="3%" />
<col width="4%" />
<col width="3%" />
<col width="6%" />
<col width="4%" />
<col width="2%" />
<col width="4%" />
<col width="3%" />
<col width="4%" />
<col width="4%" />
<col width="3%" />
<col width="4%" />
<col width="5%" />
<col width="6%" />
<col width="5%" />
<col width="4%" />
<col width="6%" />
<col width="5%" />
<col width="5%" />
<col width="2%" />
<col width="3%" />
<col width="2%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">Price</th>
<th align="right">Floor.High</th>
<th align="right">Floor.Low</th>
<th align="right">Decoration.Fine</th>
<th align="right">PlateTower</th>
<th align="right">Steel</th>
<th align="right">BuildingArea</th>
<th align="right">Fee</th>
<th align="right">d.Commercial</th>
<th align="right">d.GreenLand</th>
<th align="right">d.Water</th>
<th align="right">d.University</th>
<th align="right">d.Kindergarten</th>
<th align="right">d.PrimarySchool</th>
<th align="right">d.MiddleSchool</th>
<th align="right">d.HighSchool</th>
<th align="right">d.SubwayStation</th>
<th align="right">d.Supermarket</th>
<th align="right">d.ShoppingMall</th>
<th align="right">lon</th>
<th align="right">lat</th>
<th align="right">group</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">9.948652</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">4.443474</td>
<td align="right">0.4121097</td>
<td align="right">0</td>
<td align="right">0.0109903</td>
<td align="right">0.0235564</td>
<td align="right">-4.633394</td>
<td align="right">-6.538925</td>
<td align="right">-5.711257</td>
<td align="right">-4.977189</td>
<td align="right">-3.608064</td>
<td align="right">-4.234066</td>
<td align="right">-6.290058</td>
<td align="right">-5.20265</td>
<td align="right">114.31</td>
<td align="right">30.5233</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">9.964630</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">3.688379</td>
<td align="right">0.4121097</td>
<td align="right">0</td>
<td align="right">0.0109903</td>
<td align="right">0.0235564</td>
<td align="right">-4.633394</td>
<td align="right">-6.538925</td>
<td align="right">-5.711257</td>
<td align="right">-4.977189</td>
<td align="right">-3.608064</td>
<td align="right">-4.234066</td>
<td align="right">-6.290058</td>
<td align="right">-5.20265</td>
<td align="right">114.31</td>
<td align="right">30.5233</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">9.920984</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">4.476769</td>
<td align="right">0.4121097</td>
<td align="right">0</td>
<td align="right">0.0109903</td>
<td align="right">0.0235564</td>
<td align="right">-4.633394</td>
<td align="right">-6.538925</td>
<td align="right">-5.711257</td>
<td align="right">-4.977189</td>
<td align="right">-3.608064</td>
<td align="right">-4.234066</td>
<td align="right">-6.290058</td>
<td align="right">-5.20265</td>
<td align="right">114.31</td>
<td align="right">30.5233</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">9.980958</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">4.742843</td>
<td align="right">0.4121097</td>
<td align="right">0</td>
<td align="right">0.0109903</td>
<td align="right">0.0235564</td>
<td align="right">-4.633394</td>
<td align="right">-6.538925</td>
<td align="right">-5.711257</td>
<td align="right">-4.977189</td>
<td align="right">-3.608064</td>
<td align="right">-4.234066</td>
<td align="right">-6.290058</td>
<td align="right">-5.20265</td>
<td align="right">114.31</td>
<td align="right">30.5233</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">9.904037</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">3.688379</td>
<td align="right">0.4121097</td>
<td align="right">0</td>
<td align="right">0.0109903</td>
<td align="right">0.0235564</td>
<td align="right">-4.633394</td>
<td align="right">-6.538925</td>
<td align="right">-5.711257</td>
<td align="right">-4.977189</td>
<td align="right">-3.608064</td>
<td align="right">-4.234066</td>
<td align="right">-6.290058</td>
<td align="right">-5.20265</td>
<td align="right">114.31</td>
<td align="right">30.5233</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">10.001249</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">3.708927</td>
<td align="right">0.4121097</td>
<td align="right">0</td>
<td align="right">0.0109903</td>
<td align="right">0.0235564</td>
<td align="right">-4.633394</td>
<td align="right">-6.538925</td>
<td align="right">-5.711257</td>
<td align="right">-4.977189</td>
<td align="right">-3.608064</td>
<td align="right">-4.234066</td>
<td align="right">-6.290058</td>
<td align="right">-5.20265</td>
<td align="right">114.31</td>
<td align="right">30.5233</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(house_coords)</span></code></pre></div>
<pre><code>##          X       Y
## 1 529753.7 3378166
## 2 527904.4 3397964
## 3 517830.9 3388271
## 4 524841.7 3399656
## 5 531325.0 3378675
## 6 524219.7 3398945</code></pre>
<p>This data set, collected in 2018, has 19,854 properties located in
795 communities. In each observation, there are fields of house
properties, locational and neighbourhood variables. In details, they are
distances to nearby educational resources (kindergartens, primary
schools, middle schools, high schools, universities), commercial areas
(business districts, shopping malls and supermarkets), transportation
facilities (metro stations and bus stations), rivers, lakes, and green
lands. The following figure shows the distribution of these properties,
and the table gives information about all available variables.</p>
<div class="figure">
<img src="assets/CaseStudy1_WuhanHouseData.jpeg" alt="" />
<p class="caption">Map of second-hand properties</p>
</div>
<table>
<colgroup>
<col width="16%" />
<col width="55%" />
<col width="5%" />
<col width="12%" />
<col width="8%" />
</colgroup>
<thead>
<tr class="header">
<th>Variables</th>
<th>Value</th>
<th>Level</th>
<th>Type</th>
<th>Logarithm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><em>Price</em></td>
<td>House price per square metre.</td>
<td>Sample</td>
<td>Dependent</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>Floor.High</em></td>
<td>1 if a property is on a high floor, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="odd">
<td><em>Floor.Low</em></td>
<td>1 if a property is on a low floor, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="even">
<td><em>Decoration.Fine</em></td>
<td>1 if a property is well decorated, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="odd">
<td><em>PlateTower</em></td>
<td>1 if a property is of the plate-tower type, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="even">
<td><em>Steel</em></td>
<td>1 if a property is of ‘steel’ structure, otherwise 0.</td>
<td>Sample</td>
<td>Structural</td>
<td></td>
</tr>
<tr class="odd">
<td><em>BuildingArea</em></td>
<td>Building area in square metres.</td>
<td>Sample</td>
<td>Structural</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>Fee</em></td>
<td>Management fee per square meter per month.</td>
<td>Group</td>
<td>Neighbourhood</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.Commercial</em></td>
<td>Distance to the nearest commercial area.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.Greenland</em></td>
<td>Distance to the nearest green land.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.Water</em></td>
<td>Distance to the nearest river or lake.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.University</em></td>
<td>Distance to the nearest university.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.HighSchool</em></td>
<td>Distance to the nearest high school.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.MiddleSchool</em></td>
<td>Distance to the nearest middle school.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.PrimarySchool</em></td>
<td>Distance to the nearest primary school.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.Kindergarten</em></td>
<td>Distance to the nearest kindergarten.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.SubwayStation</em></td>
<td>Distance to the nearest subway station.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="even">
<td><em>d.Supermarket</em></td>
<td>Distance to the nearest supermarket.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
<tr class="odd">
<td><em>d.ShoppingMall</em></td>
<td>Distance to the nearest shopping mall.</td>
<td>Group</td>
<td>Locational</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>After a variable selection process <span class="citation">(<a
href="#ref-HuLu-2022" role="doc-biblioref">Hu et al. 2022</a>)</span>,
we use these factors to build a HGWR model:</p>
<ul>
<li><em>Fee</em></li>
<li><em>d.Water</em></li>
<li><em>d.Commercial</em></li>
<li><em>d.PrimarySchool</em></li>
<li><em>d.Kindergarten</em></li>
<li><em>BuildingArea</em></li>
<li><em>Floor.High</em></li>
</ul>
<p>And regards the locational and Fee as local fixed effects, the
BuildingArea as global fixed effects and Floor.High as random effects.
Then we can calibrate a HGWR model with the following codes.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>hp_hgwr <span class="ot">&lt;-</span> <span class="fu">hgwr</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> Price <span class="sc">~</span> d.Water <span class="sc">+</span> d.Commercial <span class="sc">+</span> d.PrimarySchool <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>            d.Kindergarten <span class="sc">+</span> Fee <span class="sc">+</span> BuildingArea <span class="sc">+</span> (Floor.High <span class="sc">|</span> group),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> house_price,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">local.fixed =</span> <span class="fu">c</span>(<span class="st">&quot;d.Water&quot;</span>, <span class="st">&quot;d.Commercial&quot;</span>, <span class="st">&quot;d.PrimarySchool&quot;</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;d.Kindergarten&quot;</span>, <span class="st">&quot;Fee&quot;</span>),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> house_coords,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bw =</span> <span class="dv">50</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernel =</span> <span class="st">&quot;bisquared&quot;</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">eps_gradient =</span> <span class="fl">1e-16</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">eps_iter =</span> <span class="fl">1e-16</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>hp_hgwr</span></code></pre></div>
<pre><code>## Hierarchical and geographically weighted regression model 
## ========================================================= 
## Formula: Price ~ d.Water + d.Commercial + d.PrimarySchool + d.Kindergarten +      Fee + BuildingArea + (Floor.High | group) 
##  Method: Back-fitting and Maximum likelihood 
##    Data: house_price 
## 
## Global Fixed Effects 
## ------------------- 
##  Intercept  BuildingArea 
##   9.937560     -0.018742 
## 
## Local Fixed Effects 
## ------------------- 
##      Coefficient         Min  1st Quartile     Median  3rd Quartile        Max 
##        Intercept   -4.231886     -0.306639   0.008463      0.336110   6.876787 
##          d.Water  -29.299502     -7.077296  -1.779663      2.195323  17.210490 
##     d.Commercial  -60.736536     -6.656764  -2.714291      2.985110  89.944929 
##  d.PrimarySchool   -0.199244     -0.049623  -0.024770      0.006988   0.203054 
##   d.Kindergarten   -0.947448     -0.031277   0.000478      0.018205   1.433052 
##              Fee    0.007114      0.099858   0.141523      0.186026   0.370990 
## 
## Random Effects 
## -------------- 
##    Groups        Name  Std.Dev.      Corr 
##     group   Intercept  0.081804           
##            Floor.High  0.081804  0.000000 
##  Residual              0.081804           
## 
## Other Information 
## ----------------- 
## Number of Obs: 19599 
##        Groups: group , 779</code></pre>
<p>We can also make some maps to visualize the estimated coefficients.
<a href="./data/wuhan.geojson">Boundary data of Wuhan</a> is provided.
It is in GeoJSON format and can be loaded by package
<strong>rgdal</strong>. For coefficients, we can simply combine it with
coordinates of houses. Because coefficients, coordinates and groups can
be one-to-one matched.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>wuhan <span class="ot">&lt;-</span> rgdal<span class="sc">::</span><span class="fu">readOGR</span>(<span class="st">&quot;data/wuhan.geojson&quot;</span>)</span></code></pre></div>
<pre><code>## OGR data source with driver: GeoJSON 
## Source: &quot;C:\Users\rd21411\Develop\hlmgwr-backfitting-ml-doc\data\wuhan.geojson&quot;, layer: &quot;Wuhan&quot;
## with 13 features
## It has 6 fields</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>hp_coef_sp <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">coef</span>(hp_hgwr), <span class="fu">as.data.frame</span>(house_coords)) <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>), <span class="at">crs =</span> <span class="dv">4547</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>hp_basemap <span class="ot">&lt;-</span> <span class="fu">tm_shape</span>(wuhan) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">col =</span> <span class="st">&quot;white&quot;</span>)</span></code></pre></div>
<p>Then visualize coefficients estimations with the basemap.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">&quot;d.Water&quot;</span>, <span class="st">&quot;d.Commercial&quot;</span>, <span class="st">&quot;d.PrimarySchool&quot;</span>, <span class="st">&quot;d.Kindergarten&quot;</span>,</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Fee&quot;</span>, <span class="st">&quot;BuildingArea&quot;</span>, <span class="st">&quot;Floor.High&quot;</span>, <span class="st">&quot;Intercept&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="cf">function</span>(var) {</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    hp_basemap <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_shape</span>(hp_coef_sp, <span class="at">is.master =</span> T) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tm_dots</span>(<span class="at">col =</span> var, <span class="at">size =</span> <span class="fl">0.1</span>, <span class="at">midpoint =</span> <span class="dv">0</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">palette =</span> <span class="st">&quot;-RdBu&quot;</span>, <span class="at">legend.col.reverse =</span> T)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tmap_arrange</span>(<span class="at">nrow =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" width="4200" /></p>
<p>From this figure, we can see that as <em>BuildingArea</em> is
regarded as global fixed effects, for all samples there is only one
estimations. As <em>Floor.High</em> is regarded as random effects, each
group has a unique estimation but no spatial relationship can be seen.
For local fixed effects, their estimations seems to be locally related.
This is suggested by the first law of geography. Besides, spatial
heterogeneity is also obvious in their estimations.</p>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="unnumbered">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-BrunsdonFotheringham-1996" class="csl-entry">
Brunsdon, Chris, A. Stewart Fotheringham, and Martin E. Charlton. 1996.
<span>“Geographically <span>Weighted Regression</span>: <span>A
Method</span> for <span>Exploring Spatial
Nonstationarity</span>.”</span> <em>Geographical Analysis</em> 28 (4):
281–98. <a
href="https://doi.org/10.1111/j.1538-4632.1996.tb00936.x">https://doi.org/10.1111/j.1538-4632.1996.tb00936.x</a>.
</div>
<div id="ref-FotheringhamBrunsdon-2002" class="csl-entry">
Fotheringham, A. Stewart, Chris Brunsdon, and Martin Charlton. 2002.
<em>Geographically Weighted Regression: The Analysis of Spatially
Varying Relationships</em>. <span>Chichester, England ; Hoboken, NJ,
USA</span>: <span>Wiley</span>.
</div>
<div id="ref-FotheringhamYang-2017" class="csl-entry">
Fotheringham, A. Stewart, Wenbai Yang, and Wei Kang. 2017.
<span>“Multiscale <span>Geographically Weighted Regression</span>
(<span>MGWR</span>).”</span> <em>Annals of the American Association of
Geographers</em> 107 (6): 1247–65. <a
href="https://doi.org/10.1080/24694452.2017.1352480">https://doi.org/10.1080/24694452.2017.1352480</a>.
</div>
<div id="ref-HuLu-2022" class="csl-entry">
Hu, Yigong, Binbin Lu, Yong Ge, and Guanpeng Dong. 2022.
<span>“Uncovering Spatial Heterogeneity in Real Estate Prices via
Combined Hierarchical Linear Model and Geographically Weighted
Regression.”</span> <em>Environment and Planning B: Urban Analytics and
City Science</em>, January, 239980832110638. <a
href="https://doi.org/10.1177/23998083211063885">https://doi.org/10.1177/23998083211063885</a>.
</div>
<div id="ref-Raudenbush-1993" class="csl-entry">
Raudenbush, Stephen W. 1993. <span>“Hierarchical <span>Linear
Models</span> and <span>Experimental Design</span>.”</span> In
<em>Applied Analysis of Variance in Behavioral Science</em>, 459–96.
<span>L. K. Edwards</span>.
</div>
<div id="ref-Tobler-1970" class="csl-entry">
Tobler, W. R. 1970. <span>“A <span>Computer Movie Simulating Urban
Growth</span> in the <span>Detroit Region</span>.”</span> <em>Economic
Geography</em> 46 (June): 234. <a
href="https://doi.org/10.2307/143141">https://doi.org/10.2307/143141</a>.
</div>
</div>
</div>
</div>

   
   
            
      

  <script>
    $(document).ready(function () {

			
 		
	    });
  </script>



    <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
	document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>
  
</body>
</html>
